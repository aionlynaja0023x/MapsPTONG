z<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Navigation to Sawang Daen Din Buildings</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 50vh; width: 100%; }
        #video { width: 100%; height: 50vh; object-fit: cover; }
        #overlay { 
            position: absolute; 
            top: 50vh; 
            left: 0; 
            width: 100%; 
            height: 50vh; 
            pointer-events: none; 
            z-index: 1000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: red; 
            font-size: 24px; 
            font-weight: bold; 
            text-shadow: 0 0 5px white; 
        }
        #controls { 
            padding: 10px; 
            background: #fff; 
            box-shadow: 0 0 5px rgba(0,0,0,0.2); 
        }
        select, button { 
            margin: 5px; 
            padding: 8px; 
            font-size: 16px; 
        }
    </style>
</head>
<body>
    <div id="controls">
        <select id="destinationSelect">
            <option value="">Select Destination</option>
            <option value="ortho">ตึกศัลยกรรมกระดูก (Orthopedic Surgery)</option>
            <option value="thai">อาคารแพทย์แผนไทย (Traditional Thai Medicine)</option>
        </select>
        <button onclick="startNavigation()">Start Navigation</button>
        <button onclick="stopNavigation()">Stop Navigation</button>
    </div>
    <div id="map"></div>
    <video id="video" autoplay playsinline></video>
    <div id="overlay"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Sawang Daen Din
        const map = L.map('map').setView([17.47724, 103.4579086], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let userMarker, routeLayer, video, stream, destination, routeCoords = [], routeInstructions = [];
        const overlay = document.getElementById('overlay');
        const destinations = {
            ortho: { lat: 17.4775173, lng: 103.4585825, name: 'ตึกศัลยกรรมกระดูก' },
            thai: { lat: 17.4771491, lng: 103.4590181, name: 'อาคารแพทย์แผนไทย' }
        };

        // Watch user location in real time
        let watchId = null;
        function startLocationWatch() {
            if (watchId !== null) return;
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    if (!userMarker) {
                        userMarker = L.marker([latitude, longitude]).addTo(map);
                        map.setView([latitude, longitude], 18);
                    } else {
                        userMarker.setLatLng([latitude, longitude]);
                    }
                    updateNavigation([latitude, longitude]);
                },
                (error) => console.error('Geolocation error:', error),
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        }
        function stopLocationWatch() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        // Start camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video = document.getElementById('video');
                video.srcObject = stream;
                video.style.display = 'block';
                overlay.style.display = 'flex';
            } catch (err) {
                console.error('Camera error:', err);
                alert('Failed to access camera. Ensure HTTPS and camera permissions.');
            }
        }

        // Stop camera
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
                overlay.style.display = 'none';
            }
        }

        // Calculate route using OpenRouteService
        async function getRoute(start, end) {
            const apiKey = '5b3ce3597851110001cf6248d0b9e6f8a4c04f7e9b2c3d5e7f1a2b3c'; // Replace with your OpenRouteService API key
            const url = `https://api.openrouteservice.org/v2/directions/foot-walking/geojson`;
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    coordinates: [[start[1], start[0]], [end[1], end[0]]],
                    instructions: true
                })
            });
            const data = await response.json();
            // Extract coordinates and instructions
            routeCoords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
            routeInstructions = data.features[0].properties.segments[0].steps.map(step => ({
                instruction: step.instruction,
                lat: step.way_points ? routeCoords[step.way_points[0]]?.[0] : null,
                lng: step.way_points ? routeCoords[step.way_points[0]]?.[1] : null
            }));
            return data;
        }

        // Calculate distance between two points (Haversine)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const toRad = x => x * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Update navigation instructions in real time
        function updateNavigation(userLatLng) {
            if (!destination || !userLatLng || routeInstructions.length === 0) return;
            let minDist = Infinity, nearestStep = null;
            for (const step of routeInstructions) {
                if (step.lat && step.lng) {
                    const dist = getDistance(userLatLng[0], userLatLng[1], step.lat, step.lng);
                    if (dist < minDist) {
                        minDist = dist;
                        nearestStep = step;
                    }
                }
            }
            // ถ้าใกล้จุดเลี้ยวมากๆ ให้แสดงคำแนะนำของ step ถัดไป
            if (minDist < 15 && nearestStep) {
                overlay.textContent = nearestStep.instruction;
            } else if (minDist < 50 && nearestStep) {
                overlay.textContent = 'เตรียม ' + nearestStep.instruction;
            } else {
                overlay.textContent = 'เดินตรงไปตามเส้นทาง';
            }
        }

        // Start navigation
        async function startNavigation() {
            const selected = document.getElementById('destinationSelect').value;
            if (!selected) {
                alert('Please select a destination.');
                return;
            }
            destination = destinations[selected];
            L.marker([destination.lat, destination.lng]).addTo(map).bindPopup(destination.name).openPopup();
            map.setView([destination.lat, destination.lng], 18);
            await startCamera();
            startLocationWatch();

            // รอให้ userMarker มีตำแหน่งก่อนคำนวณเส้นทาง
            let waitCount = 0;
            while (!userMarker && waitCount < 20) {
                await new Promise(r => setTimeout(r, 300));
                waitCount++;
            }
            if (!userMarker) {
                alert('ไม่สามารถดึงตำแหน่งผู้ใช้ได้');
                return;
            }
            const userPos = userMarker.getLatLng();
            const routeData = await getRoute([userPos.lat, userPos.lng], [destination.lat, destination.lng]);
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(routeData, {
                style: { color: '#0000FF', weight: 5 }
            }).addTo(map);
            map.fitBounds(routeLayer.getBounds());
        }

        // Stop navigation
        function stopNavigation() {
            stopCamera();
            stopLocationWatch();
            if (routeLayer) map.removeLayer(routeLayer);
            overlay.textContent = '';
            destination = null;
            routeCoords = [];
            routeInstructions = [];
        }
    </script>
</body>
</html>